<!-- ******************************************* -->
<!-- TCSS 558: Homework 1                        -->
<!-- Winter 2022, Applied Distributed Computing  -->
<!-- based on sample code provided by Eyhab      -->
<!-- Al-Masri in TCSS 573. Adapted from sample   -->
<!-- code provided by Microsoft                  -->
<!--                                             -->
<!-- This code allows the upload of an image     -->
<!-- file which is then processed by our Django  -->
<!-- proxy server and returns the classification -->
<!-- and scene description of the image          -->
<!-- ******************************************* -->

<!DOCTYPE html>
<html>
<head>
    <title>What Is This Thing?</title>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
    <!-- using the Darkly style sheet. Go to https://bootswatch.com/ and click on Themes and select a theme if you wish to change this current theme! -->
    <link rel="stylesheet" href="https://bootswatch.com/5/darkly/bootstrap.css">
</head>

<!-- onload calls a function that initializes some HTML elements -->
<body onload="initElements()">

    <br>
    <h1 class="text-primary" style="text-align:center"> What Is This Thing? </h1>
    <h3 style="text-align:center"> Upload an Image and Let an AI Try to Guess!</h3>
    <br>
    <br>


    <!-- this form handles user input: -->
    <!-- uploading images and sending them to proxy server and requesting history -->
    <form style="text-align:center">
        <h4 class="card-title">Select an image</h4>
        <input type="file" class="btn btn-primary"/>
        <a id=sendToProxyBtn class="btn btn-success btn-lg">OK</a>
        <a id=requestHistoryBtn class="btn btn-info btn-lg">History</a>
    </form>
    <br>


    <script type="text/javascript">

        // globals to be updated after file upload
        var data = null;
        var name = null;
        var type = null;

        // Hide the following HTML elements when page (HTML body) loads in browser. 
        function initElements() {
            $ ("#loader").hide();
            $ ("#imageInfo").hide();
            $ ("#historyInfo").hide();
            $ ("input[type=file]").val('');
        }

        // Callback from a <input type="file" onchange="analyzeImage(this)"> - see the <form>...</form> HTML code above
        // This callback function is called when a file is selected
        // the function is attached to the change event (e.g., when a file is uploaded), which triggers this function. 
        // that is, when you select a file from your local computer, the selection is change
        // which triggers this function
        $('input[type=file]').change(function () {
           //$("#resultsInfo tr").remove();
           //$("#tag_info tr").remove();

            var file = this.files[0];           // first file selected
            var fileReader = new FileReader();  // create FileReader instance to read local file
            fileReader.onload = function(event) {
                data = file;
                name = file.name;
                type = file.type;
            }; 

            fileReader.onerror = function() {
                alert(fileReader.error);
            }; 
    
            fileReader.readAsArrayBuffer(file);
        });


        // **************** callback for the OK button ****************
        $('a[id=sendToProxyBtn]').click(function () {
            
            if (data == null) {
                alert("Please upload a file first");
            } else {
                var form = new FormData();
                form.append("image", data, name);
                form.append("name", name);

                $.ajax({
                    url:"http://127.0.0.1:8000/api/images",
                    beforeSend: function(dummy) { $ ("#loader").show(); },
                    complete: function(dummy) { $ ("#loader").hide(); },
                    type: "POST",
                    timeout: 0,
                    processData: false,
                    mimeType: "multipart/form-data",
                    contentType: false,
                    data: form,

                })

                    .done(function (json_response) {
                        $ ("#historyInfo").hide();  // valid response, hide history table 

                        var obj = JSON.parse(json_response);
                        var prediction_tags = obj.classification;
                        var prediction_desc = obj.description;

                        // display the chosen image on the HTML page
                        // get the path of the image file
                        var path = (window.URL || window.webkitURL).createObjectURL(data);
                        $ ("#imgsrc").attr("src", path);
                        $ ("#imageInfo").show();

                        // map the values of the data parsed from JSON response message 
                        // to HTML elements within the HTML file dynamically. 
                        $("#imageDescription").text(prediction_desc);
                        $("#imageTags").text(prediction_tags);
                    })
                    .fail(function () {
                        $ ("loader").hide(); 
                        alert("server error");
                    })
            }
        })
        
        // **************** callback for the history button ****************
        $('a[id=requestHistoryBtn]').click(function () {
            $ ("#historyInfo").hide();
            $("#historyTable tbody tr").remove();
            $ ("#imageInfo").hide();

            $.ajax({
                url:"http://127.0.0.1:8000/api/images",
                beforeSend: function(dummy) { $ ("#loader").show(); },
                complete: function(dummy) { $ ("#loader").hide(); },
                type: "GET",
            })
                .done(function (json_response) {
                    $ ("#historyInfo").show(); // build the table with provided info
                    for (const [index, element] of json_response.entries()) {
                        $("#historyTable").find('tbody')
                            .append($('<tr>')
                                .append($('<td>')
                                    .text(index))
                                .append($('<td>')
                                    .text(element.name))
                                .append($('<td>')
                                    .text(element.classification))
                                .append($('<td>')
                                    .text(element.description))
                                .append($('<td>')
                                    .text(element.timestamp))
                            );
                    }
                })

                .fail(function () {
                    alert("server error");
                })
        })

    </script>

    <style>
      body {
        text-align: center;
      }
      img {
        max-width: 600px;
        max-height: 100%;
        border: 1px solid white;
      }
    </style>

    <div class="container" id=loader>
        <div class="page-header" id="banner">
            <div class="spinner-border text-secondary" role="status">
            </div>
        </div>
    </div>

    <div class="container" id=imageInfo>
        <div class="page-header" id="banner">
                
            <!-- Uploaded Image -->
            <img id="imgsrc">

            <!-- Results Information -->
            <h3 id=imageDescription> </h3>
            <h4 class="text-primary" id=imageTags> </h4>

        </div>
    </div>

    <!-- Site Usage History -->
    <div class="container" id=historyInfo>
        <div class="page-header" id="banner">
            <table id="historyTable" class="table table-striped table-hover ">
                <thead>
                    <tr>
                      <th>#</th>
                      <th>File Name</th>
                      <th>Classification</th>
                      <th>Description</th>
                      <th>Timestamp</th>
                    </tr>
                </thead>
                <tbody>

                </tbody>
            </table>
        </div>
    </div>
</body>
</html>